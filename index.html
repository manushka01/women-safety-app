<!DOCTYPE html>
<html>
<head>
  <title>Women Safety AI Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

  <style>
    body { margin:0; font-family:Arial; }
    #map { height:85vh; width:100%; }
    .top-bar { padding:10px; text-align:center; background:#b30021; color:white; }
    .risk-box { text-align:center; padding:8px; font-weight:bold; font-size:18px; background:#111; color:white; }
    button { padding:8px; margin:5px; border:none; border-radius:5px; cursor:pointer; }
    input { padding:8px; margin:5px; width:200px; }
  </style>
</head>

<body>

<div class="top-bar">
  <h2>Women Safety AI Map</h2>
  <button onclick="toggleDarkMode()">ðŸŒ™ Dark</button>
  <button onclick="triggerSOS()">ðŸš¨ SOS</button>
  <button onclick="startVoiceSOS()">ðŸŽ¤ Voice</button>
  <button onclick="fakeCall()">ðŸ“ž Fake Call</button>
  <input type="text" id="searchInput" placeholder="Search location">
  <button onclick="searchLocation()">Search</button>
  <button onclick="safeRoute()">Safe Route</button>
  <button onclick="toggleHeatmap()">ðŸ”¥ Heatmap</button>
  <button onclick="shareLiveLocation()">ðŸ”µ Share</button>
</div>

<div class="risk-box" id="riskStatus">Risk Level: Waiting for location...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBrJVLDQ1iiIEXDLrHLnwsrwOVbQn1Dx6k",
  authDomain: "women-safety-app-62766.firebaseapp.com",
  databaseURL: "https://women-safety-app-62766-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "women-safety-app-62766",
  storageBucket: "women-safety-app-62766.firebasestorage.app",
  messagingSenderId: "23376683007",
  appId: "1:23376683007:web:7c5acf53b9fa53491751ca"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* UNIQUE USER ID */
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = "user_" + Math.floor(Math.random() * 100000);
  localStorage.setItem("userId", userId);
}

/* MAP INIT */
var map = L.map('map').setView([26.8467, 80.9462], 13);
var lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');

var isDark=false;
var userLat,userLng,userMarker;
var searchedLat=null, searchedLng=null;
var routingControl;
var heatLayer;
var movementPath=[];
var movementLine=null;
var policeMarkers=[];

var dangerZones=[
  [26.850,80.949,0.8],
  [26.840,80.940,0.7],
  [26.845,80.955,0.9]
];

heatLayer=L.heatLayer(dangerZones,{radius:25});

/* LIVE LOCATION */
navigator.geolocation.watchPosition(function(pos){

  userLat=pos.coords.latitude;
  userLng=pos.coords.longitude;

  if(userMarker){
    userMarker.setLatLng([userLat,userLng]);
  } else {
    userMarker=L.marker([userLat,userLng]).addTo(map)
      .bindPopup("You are here").openPopup();
  }

  map.setView([userLat,userLng],16);

  movementPath.push([userLat,userLng]);

  if(!movementLine){
    movementLine=L.polyline(movementPath,{color:'blue'}).addTo(map);
  } else {
    movementLine.setLatLngs(movementPath);
  }

  calculateRisk();
  checkDangerZone();
  findNearbyPolice();

  database.ref("users/" + userId).update({
  lat:userLat,
  lng:userLng,
  time:Date.now(),
  sos:false
});

}, function(){
  alert("Please allow location access");
},{enableHighAccuracy:true});

/* DARK MODE */
function toggleDarkMode(){
  if(isDark){ map.removeLayer(darkLayer); map.addLayer(lightLayer); }
  else { map.removeLayer(lightLayer); map.addLayer(darkLayer); }
  isDark=!isDark;
}

/* SOS */
function triggerSOS(){

  if(!userLat){
    alert("Location not ready");
    return;
  }

  database.ref("users/" + userId).update({
    sos:true,
    lat:userLat,
    lng:userLng,
    time:Date.now()
  });

  let mapLink="https://www.google.com/maps?q="+userLat+","+userLng;

  window.location.href="tel:112";

  setTimeout(function(){
    window.open("https://api.whatsapp.com/send?text="+
    encodeURIComponent("ðŸš¨ EMERGENCY! I need help. My live location: "+mapLink));
  },1500);
}

/* VOICE SOS */
function startVoiceSOS(){
  const rec=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.start();
  rec.onresult=function(e){
    if(e.results[0][0].transcript.toLowerCase().includes("help")){
      triggerSOS();
    }
  };
}

/* FAKE CALL */
function fakeCall(){
  alert("ðŸ“ž Incoming Call from: Mom");
  setTimeout(()=>alert("ðŸ“ž Talking..."),2000);
}

/* SEARCH */
function searchLocation(){
  var location=document.getElementById("searchInput").value;
  if(!location) return alert("Enter location");

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${location}`)
  .then(res=>res.json())
  .then(data=>{
    if(data.length>0){
      searchedLat=parseFloat(data[0].lat);
      searchedLng=parseFloat(data[0].lon);
      map.setView([searchedLat,searchedLng],15);
      L.marker([searchedLat,searchedLng]).addTo(map).bindPopup(location).openPopup();
    }
  });
}

/* SAFE ROUTE */
function safeRoute(){
  if(!userLat) return alert("Location not ready");
  if(!searchedLat) return alert("Search a destination first");
  if(routingControl) map.removeControl(routingControl);
  routingControl=L.Routing.control({
    waypoints:[L.latLng(userLat,userLng),L.latLng(searchedLat,searchedLng)]
  }).addTo(map);
}

/* HEATMAP */
function toggleHeatmap(){
  if(map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
  else map.addLayer(heatLayer);
}

/* DANGER ZONE */
function checkDangerZone(){
  dangerZones.forEach(zone=>{
    var dist=map.distance([userLat,userLng],[zone[0],zone[1]]);
    if(dist<200) alert("âš  Warning: Unsafe Area!");
  });
}

/* RISK */
function calculateRisk(){
  let score=0;
  let hour=new Date().getHours();
  if(hour>=20||hour<=5) score+=40;
  dangerZones.forEach(zone=>{
    let dist=map.distance([userLat,userLng],[zone[0],zone[1]]);
    if(dist<300) score+=50;
  });
  let status=document.getElementById("riskStatus");
  if(score>=60){ status.innerHTML="ðŸ”´ High Risk Area"; status.style.color="red"; }
  else if(score>=30){ status.innerHTML="ðŸŸ¡ Medium Risk Area"; status.style.color="orange"; }
  else{ status.innerHTML="ðŸŸ¢ Safe Area"; status.style.color="lime"; }
}

/* POLICE */
function findNearbyPolice(){
  if(!userLat) return;
  policeMarkers.forEach(m=>map.removeLayer(m));
  policeMarkers=[];
  let query=`[out:json];node["amenity"="police"](around:3000,${userLat},${userLng});out;`;
  fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query})
  .then(res=>res.json())
  .then(data=>{
    data.elements.forEach(station=>{
      let marker=L.marker([station.lat,station.lon]).addTo(map)
      .bindPopup("ðŸš“ Police Station");
      policeMarkers.push(marker);
    });
  });
}

/* SHARE */
function shareLiveLocation(){
  if(!userLat) return alert("Location not ready");
  var link=window.location.origin+"/guardian.html";
  window.open("https://api.whatsapp.com/send?text="+
  encodeURIComponent("Track my live location: "+link));
}

</script>
</body>
</html>
